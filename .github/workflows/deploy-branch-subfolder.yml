# Workflow to deploy content from any branch into a subfolder on the main branch
name: Deploy Branch to Subfolder

on:
  push:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-to-subfolder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        if: ${{ !env.ACT }}
        with:
          ref: main
          fetch-depth: 0
      
      - name: Checkout source branch
        uses: actions/checkout@v4
        if: ${{ !env.ACT }}
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Node.js for build (act)
        if: ${{ env.ACT }}
        run: |
          npm install
          npx playwright install --with-deps
        working-directory: ${{ github.workspace }}

      - name: Build branch content and generate PDFs (act)
        if: ${{ env.ACT }}
        run: |
          npm run build
          echo "ðŸ“„ Generating PDFs for branch..."
          # Only run PDF generation if the script exists in package.json
          node -e "try{const s=require(process.cwd()+'/package.json').scripts||{}; process.exit(s['pdf:all']?0:1)}catch(e){process.exit(1)}" \
            && npm run pdf:all || echo "No 'pdf:all' script found â€” skipping PDF generation (act)"
        working-directory: ${{ github.workspace }}
        env:
          BASE_PATH: /cv/${{ github.ref_name }}
          BRANCH_NAME: ${{ github.ref_name }}

      - name: Build and copy all branches
        if: ${{ !env.ACT }}
        run: |
          git fetch --all --prune
          # List only remote branch refs under origin, strip the 'origin/' prefix,
          # and exclude main and HEAD entries.
          # Determine remote to use (prefer 'origin', fall back to first remote)
          REMOTE=$(git remote | grep -E '^origin$' || true)
          if [ -z "$REMOTE" ]; then
            REMOTE=$(git remote | head -n1)
          fi

          # List remote branch heads robustly and exclude main/HEAD
          BRANCHES=$(git ls-remote --heads "$REMOTE" | awk '{print $2}' | sed 's#refs/heads/##' | grep -v '^main$' | grep -v '^HEAD$' || true)

          for BRANCH_NAME in $BRANCHES; do
            echo "ðŸ“„ Processing branch: $BRANCH_NAME"
            rm -rf source-branch-build
            git worktree add --force source-branch-build "origin/$BRANCH_NAME"

            pushd source-branch-build
            npm install
            npx playwright install --with-deps
            npm run build
            echo "ðŸ“„ Generating PDFs for branch..."
            # Only run PDF generation for this branch if `pdf:all` is defined in its package.json
            pushd source-branch-build >/dev/null
            node -e "try{const s=require(process.cwd()+'/package.json').scripts||{}; process.exit(s['pdf:all']?0:1)}catch(e){process.exit(1)}" \
              && BRANCH_NAME="$BRANCH_NAME" BASE_PATH="/cv/$BRANCH_NAME" npm run pdf:all || echo "No 'pdf:all' script in $BRANCH_NAME â€” skipping PDFs"
            popd >/dev/null
            popd

            rm -rf "$BRANCH_NAME"
            mkdir -p "$BRANCH_NAME"
            cp source-branch-build/index.html source-branch-build/index-fr.html source-branch-build/index-en.html source-branch-build/style.min.css source-branch-build/style-web.min.css "$BRANCH_NAME"/
            cp source-branch-build/exports/*.pdf "$BRANCH_NAME"/
            echo "Files copied to $BRANCH_NAME folder:"
            ls -la "$BRANCH_NAME"/

            git worktree remove --force source-branch-build
          done

          echo "Git status after copying files:"
          git status

      - name: Upload PDFs as artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-all-branches
          path: ${{ github.workspace }}/*/cv-*.pdf
          if-no-files-found: error
      
      - name: Commit and push changes to main
        if: ${{ !env.ACT }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add -f */
          git status
          git commit -m "Update branch subfolders from all branches [skip ci]" || echo "No changes to commit"
          git push origin main
      
      - name: Notify deployment status
        if: ${{ !env.ACT }}
        run: |
          echo "âœ… Files copied to branch folders in main branch"
          echo "ðŸ“‹ Manual step may be required if automatic deployment is not configured:"
          echo "1. Go to GitHub Actions tab"
          echo "2. Find 'Deploy static content to Pages' workflow (if it exists)"
          echo "3. Click 'Run workflow' to deploy the updated folders"
          echo "4. After deployment, check:"
          echo "   - https://etiennelescot.github.io/cv/ (main content)"
          echo "   - https://etiennelescot.github.io/cv/<branch>/ (branch content)"

      - name: List generated PDFs (act)
        if: ${{ env.ACT }}
        run: |
          ls -la "$GITHUB_WORKSPACE/exports" || true
